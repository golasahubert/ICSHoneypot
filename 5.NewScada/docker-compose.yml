version: '3.8'

services:
  # ---------------------------------------------------------
  # DATABASE SERVICE (MySQL 5.7)
  # ---------------------------------------------------------
  database:
    container_name: mysql
    image: mysql/mysql-server:5.7
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=root
      - MYSQL_PASSWORD=root
      - MYSQL_DATABASE=scadalts
    expose: ["3306"]
    command: --log_bin_trust_function_creators=1
    volumes:
      - ./SCADA-LTS/docker/volumes/databases:/docker-entrypoint-initdb.d
      - ./db_data:/var/lib/mysql
    networks:
      lts_network:
        ipv4_address: 172.25.0.7
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -proot || exit 1"]
      interval: 10s
      retries: 10
      timeout: 5s
      start_period: 60s

  # ---------------------------------------------------------
  # SCADA-LTS (HMI)
  # ---------------------------------------------------------
  scadalts:
    container_name: scadalts-1
    image: scadalts/scadalts:v2.7.4
    ports:
      - "8181:8080"
    depends_on:
      database:
        condition: service_healthy
      plc1:
        condition: service_started
      plc2:
        condition: service_started
      plc3:
        condition: service_started
    expose: ["8080", "8000"]
    volumes:
      # Standard assets
      - ./SCADA-LTS/assets:/usr/local/tomcat/webapps/Scada-LTS/assets
      - ./SCADA-LTS/1.svg:/usr/local/tomcat/webapps/Scada-LTS/uploads/1.svg
      
      # Custom Visuals (JSP/Tags only) - NO SECURITY.XML
      - ./SCADA-LTS/jsp:/honeypot_stage/jsp
      - ./SCADA-LTS/tags2:/honeypot_stage/tags

    networks:
      lts_network:
        ipv4_address: 172.25.0.2
    links:
      - database:database

    # SKRYPT STARTOWY - BEZ ZMIENNYCH ($), SAME ŚCIEŻKI
    command: 
      - /bin/bash
      - -c
      - |
        set -e
        echo "--- [Honeypot] Start procedury startowej... ---"
        
        # Wejdz do katalogu
        cd /usr/local/tomcat/webapps/Scada-LTS
        
        # KROK 1: Rozpakowanie WAR (sciezki na sztywno)
        if [ ! -d "WEB-INF" ]; then
          echo "--- [Honeypot] Brak WEB-INF. Szukam pliku WAR... ---"
          
          if [ -f "/usr/local/tomcat/webapps/Scada-LTS.war" ]; then
             jar -xvf /usr/local/tomcat/webapps/Scada-LTS.war > /dev/null
             echo "--- [Honeypot] Sukces: Rozpakowano Scada-LTS.war ---"
          else
             echo "--- [BLAD KRYTYCZNY] Nie widze pliku WAR! Oto co widze w katalogu webapps: ---"
             ls -la /usr/local/tomcat/webapps/
             echo "--- Koniec listy plikow ---"
             exit 1
          fi
        else
          echo "--- [Honeypot] Aplikacja juz rozpakowana. ---"
        fi

        # KROK 2: Wgrywanie modyfikacji wizualnych
        echo "--- [Honeypot] Wgrywanie modyfikacji wygladu... ---"

        if [ -d /honeypot_stage/jsp ]; then
          cp -r /honeypot_stage/jsp/* WEB-INF/jsp/
          echo " -> OK: pliki JSP"
        fi

        if [ -d /honeypot_stage/tags ]; then
          cp -r /honeypot_stage/tags/* WEB-INF/tags/
          echo " -> OK: pliki TAGS"
        fi

        # KROK 3: Start serwera
        echo "--- [Honeypot] Uruchamianie Tomcata... ---"
        exec /usr/local/tomcat/bin/catalina.sh run

  # ---------------------------------------------------------
  # PLCs & Simulator (Bez zmian)
  # ---------------------------------------------------------
  plc1:
    build:
      context: ./plc_1_docker
    container_name: lts_plc1_sswat
    ports:
      - "2502:502"   
      - "28080:8080" 
      - "29090:9090"
    networks:
      lts_network:
        ipv4_address: 172.25.0.3

  plc2:
    build:
      context: ./plc_2_docker
    container_name: lts_plc2_sswat
    ports:
      - "3502:502"
      - "38080:8080"
      - "39090:9090"
    networks:
      lts_network:
        ipv4_address: 172.25.0.4

  plc3:
    build:
      context: ./plc_3_docker
    container_name: lts_plc3_sswat
    ports:
      - "4502:502"
      - "48080:8080"
      - "49090:9090"
    networks:
      lts_network:
        ipv4_address: 172.25.0.5

  simulator:
    build:
      context: ./physical_sim_docker
    container_name: lts_sim_sswat
    ports:
      - "5502:502"
      - "58080:8080"
      - "59090:9090"
    networks:
      lts_network:
        ipv4_address: 172.25.0.6

networks:
  lts_network:
    name: lts_network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
